<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ§ éŒ„éŸ³å¾Œç¿»è­¯å­—å¹•å·¥å…·</title>
  <style>
    body { font-family: "Segoe UI", sans-serif; text-align: center; padding: 40px; background-color: #f4f4f4; }
    button { padding: 12px 24px; font-size: 16px; margin: 10px; border: none; border-radius: 6px; cursor: pointer; }
    #output { margin-top: 30px; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 0 8px rgba(0,0,0,0.1); font-size: 1.4em; min-height: 100px; }
    #start { background-color: #28a745; color: white; }
    #stop { background-color: #ffc107; color: black; }
    #submit { background-color: #007bff; color: white; }
    #error { color: red; font-weight: bold; }
  </style>
</head>
<body>
  {% set _ = request %}
  <h2>ğŸ§ éŒ„éŸ³å¾Œç¿»è­¯å­—å¹•å·¥å…·</h2>
  <button id="start">é–‹å§‹éŒ„éŸ³</button>
  <button id="stop" disabled>åœæ­¢éŒ„éŸ³</button>
  <button id="submit" disabled>é€å‡ºç¿»è­¯</button>
  <div id="output">å°šæœªç¿»è­¯ä»»ä½•å…§å®¹...</div>
  <div id="error"></div>

  <script>
    let mediaRecorder;
    let audioBlob;

    const startBtn = document.getElementById("start");
    const stopBtn = document.getElementById("stop");
    const submitBtn = document.getElementById("submit");
    const output = document.getElementById("output");
    const errorBox = document.getElementById("error");

    const showError = (msg) => {
      errorBox.innerText = msg;
      console.error("â— éŒ¯èª¤ï¼š", msg);
    };

    if (!navigator.mediaDevices || !window.MediaRecorder) {
      showError("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´éŒ„éŸ³åŠŸèƒ½");
      startBtn.disabled = true;
    }

    startBtn.onclick = async () => {
      errorBox.innerText = "";
      if (!MediaRecorder.isTypeSupported("audio/webm;codecs=opus")) {
        showError("æ‚¨çš„è£ç½®ä¸æ”¯æ´ WebM éŒ„éŸ³æ ¼å¼ï¼Œè«‹ä½¿ç”¨ Chrome æˆ– Android è£ç½®");
        return;
      }

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

        mediaRecorder = new MediaRecorder(stream, {
          mimeType: "audio/webm;codecs=opus"
        });

        const chunks = [];
        mediaRecorder.ondataavailable = (e) => {
          if (e.data && e.data.size > 0) chunks.push(e.data);
        };

        mediaRecorder.onstop = () => {
          if (chunks.length === 0) {
            showError("æœªéŒ„åˆ°ä»»ä½•è²éŸ³");
            return;
          }

          audioBlob = new Blob(chunks, { type: "audio/webm" });
          if (audioBlob.size < 3000) {
            showError("éŒ„éŸ³å…§å®¹å¤ªå°‘ï¼Œè«‹å†è©¦ä¸€æ¬¡");
            return;
          }

          output.innerText = "âœ… éŒ„éŸ³å®Œæˆï¼Œè«‹é€å‡ºç¿»è­¯";
          submitBtn.disabled = false;
        };

        mediaRecorder.start();
        startBtn.disabled = true;
        stopBtn.disabled = false;
        output.innerText = "ğŸ™ï¸ éŒ„éŸ³ä¸­...";
      } catch (err) {
        showError("éŒ„éŸ³å•Ÿå‹•å¤±æ•—ï¼š" + err.message);
      }
    };

    stopBtn.onclick = () => {
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }
    };

    submitBtn.onclick = async () => {
      if (!audioBlob) return showError("ç„¡æœ‰æ•ˆéŒ„éŸ³æª”ï¼Œè«‹é‡æ–°éŒ„éŸ³");

      output.innerText = "â³ ç¿»è­¯ä¸­...";
      errorBox.innerText = "";
      const formData = new FormData();
      formData.append("file", audioBlob, "recording.webm");

      try {
        const res1 = await fetch("/transcribe", { method: "POST", body: formData });
        const res1Json = await res1.json();
        const englishText = res1Json.text || "";

        const res2 = await fetch("/translate", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({ text: englishText }),
        });
        const res2Json = await res2.json();
        output.innerText = res2Json.translation || "[ç¿»è­¯å¤±æ•—]";
      } catch (err) {
        showError("ç¿»è­¯éŒ¯èª¤ï¼š" + err.message);
        output.innerText = "[ç³»çµ±éŒ¯èª¤]";
      }
    };
  </script>
</body>
</html>
